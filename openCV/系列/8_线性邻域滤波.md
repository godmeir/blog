###【OpenCV入门教程之八】线性邻域滤波专场：方框滤波、均值滤波与高斯滤波
本篇文章中，我们一起仔细探讨了OpenCV图像处理技术中比较热门的图像滤波操作。图像滤波系列文章浅墨准备花两次更新的时间来讲，此为上篇，为大家剖析了“方框滤波“，”均值滤波“和”高斯滤波“三种常见线性邻域滤波操作。而作为非线性滤波的“中值滤波”和“双边滤波”，留待我们下次剖析。

####一、理论与概念讲解
<1>关于平滑处理

“平滑处理“（smoothing）也称“模糊处理”（bluring），是一项简单且使用频率很高的图像处理方法。平滑处理的用途有很多，最常见的是用来减少图像上的噪点或者失真。在涉及到降低图像分辨率时，平滑处理是非常好用的方法。

<2>图像滤波与滤波器

首先我们看一下图像滤波的概念。图像滤波，即在尽量保留图像细节特征的条件下对目标图像的噪声进行抑制，是图像预处理中不可缺少的操作，其处理效果的好坏将直接影响到后续图像处理和分析的有效性和可靠性。

消除图像中的噪声成分叫作图像的平滑化或滤波操作。信号或图像的能量大部分集中在幅度谱的低频和中频段是很常见的，而在较高频段，感兴趣的信息经常被噪声淹没。因此一个能降低高频成分幅度的滤波器就能够减弱噪声的影响。

图像滤波的目的有两个:一是抽出对象的特征作为图像识别的特征模式;另一个是为适应图像处理的要求，消除图像数字化时所混入的噪声。

而对滤波处理的要求也有两条:一是不能损坏图像的轮廓及边缘等重要信息;二是使图像清晰视觉效果好。

平滑滤波是低频增强的空间域滤波技术。它的目的有两类：一类是模糊；另一类是消除噪音。
空间域的平滑滤波一般采用简单平均法进行，就是求邻近像元点的平均亮度值。邻域的大小与平滑的效果直接相关，邻域越大平滑的效果越好，但邻域过大，平滑会使边缘信息损失的越大，从而使输出的图像变得模糊，因此需合理选择邻域的大小。

关于滤波器，一种形象的比喻法是：我们可以把滤波器想象成一个包含加权系数的窗口，当使用这个滤波器平滑处理图像时，就把这个窗口放到图像之上，透过这个窗口来看我们得到的图像。

滤波器的种类有很多， 在新版本的OpenCV中，提供了如下五种常用的图像平滑处理操作方法，且他们分别被封装在单独的函数中，使用起来非常方便：

 
方框滤波——boxblur函数

均值滤波（邻域平均滤波）——blur函数

高斯滤波——GaussianBlur函数

中值滤波——medianBlur函数

双边滤波——bilateralFilter函数
 
今天我们要讲解的是作为线性滤波的方框滤波，均值滤波和高斯滤波。两种非线性滤波操作——中值滤波和双边滤波，我们留待下次讲解。

<3>对线性滤波器的简介

线性滤波器：线性滤波器经常用于剔除输入信号中不想要的频率或者从许多频率中选择一个想要的频率。

几种常见的线性滤波器：

* 允许低频率通过的低通滤波器。
* 允许高频率通过的高通滤波器。
* 允许一定范围频率通过的带通滤波器。
* 阻止一定范围频率通过并且允许其它频率通过的带阻滤波器。
* 允许所有频率通过、仅仅改变相位关系的全通滤波器。
* 阻止一个狭窄频率范围通过的特殊带阻滤波器，陷波滤波器（Band-stop filter）。

<4>关于滤波和模糊

关于滤波和模糊，大家往往在初次接触的时候会弄混淆，“一会儿说滤波，一会儿又说模糊，什么玩意儿啊”。
没关系，在这里，我们就来辨别一下，为大家扫清障碍。
我们上文已经提到过，滤波是将信号中特定波段频率滤除的操作，是抑制和防止干扰的一项重要措施。
为了方便说明，就拿我们经常用的高斯滤波来作例子吧。我们知道，滤波可分低通滤波和高通滤波两种。而高斯滤波是指用高斯函数作为滤波函数的滤波操作，至于是不是模糊，要看是高斯低通还是高斯高通，

低通就是模糊，高通就是锐化。

其实说白了是很简单的，对吧：
高斯滤波是指用高斯函数作为滤波函数的滤波操作。
高斯模糊就是高斯低通滤波。

<5>邻域算子与线性邻域滤波

邻域算子（局部算子）是利用给定像素周围的像素值的决定此像素的最终输出值的一种算子。而线性邻域滤波是一种常用的邻域算子，像素的输出值取决于输入像素的加权和，具体过程如下图。
邻域算子除了用于局部色调调整以外，还可以用于图像滤波，实现图像的平滑和锐化，图像边缘增强或者图像噪声的去除。本篇文章，我们介绍的主角是线性邻域滤波算子，即用不同的权重去结合一个小邻域内的像素，来得到应有的处理效果。

<6>方框滤波（box Filter）

方框滤波（box Filter）被封装在一个名为boxblur的函数中，即boxblur函数的作用是使用方框滤波器（box filter）来模糊一张图片，从src输入，从dst输出。

<7>均值滤波

均值滤波，是最简单的一种滤波操作，输出图像的每一个像素是核窗口内输入图像对应像素的像素的平均值( 所有像素加权系数相等)，其实说白了它就是归一化后的方框滤波。
我们在下文进行源码剖析时会发现，blur函数内部中其实就是调用了一下boxFilter。
下面开始讲均值滤波的内容吧。

<8>高斯滤波


1）高斯滤波的理论简析
 
高斯滤波是一种线性平滑滤波，适用于消除高斯噪声，广泛应用于图像处理的减噪过程。通俗的讲，高斯滤波就是对整幅图像进行加权平均的过程，每一个像素点的值，都由其本身和邻域内的其他像素值经过加权平均后得到。高斯滤波的具体操作是：用一个模板（或称卷积、掩模）扫描图像中的每一个像素，用模板确定的邻域内像素的加权平均灰度值去替代模板中心像素点的值。
大家常常说高斯滤波最有用的滤波操作，虽然它用起来，效率往往不是最高的。
高斯模糊技术生成的图像，其视觉效果就像是经过一个半透明屏幕在观察图像，这与镜头焦外成像效果散景以及普通照明阴影中的效果都明显不同。高斯平滑也用于计算机视觉算法中的预先处理阶段，以增强图像在不同比例大小下的图像效果（参见尺度空间表示以及尺度空间实现）。从数学的角度来看，图像的高斯模糊过程就是图像与正态分布做卷积。由于正态分布又叫作高斯分布，所以这项技术就叫作高斯模糊。
图像与圆形方框模糊做卷积将会生成更加精确的焦外成像效果。由于高斯函数的傅立叶变换是另外一个高斯函数，所以高斯模糊对于图像来说就是一个低通滤波操作。

####二、深入——OpenCV源码剖析
**FilterEngine类解析——OpenCV图像滤波核心引擎**FilterEngine类是OpenCV关于图像滤波的主力军类，OpenCV图像滤波功能的核心引擎。各种滤波函数比如blur， GaussianBlur，到头来其实是就是在函数末尾处定义了一个Ptr<FilterEngine>类型的f，然后f->apply( src, dst )了一下而已。
这个类可以把几乎是所有的滤波操作施加到图像上。它包含了所有必要的中间缓存器。有很多和滤波相关的create系函数的返回值直接就是Ptr<FilterEngine>。比如cv::createSeparableLinearFilter(),
 cv::createLinearFilter(),cv::createGaussianFilter(), cv::createDerivFilter(),
 cv::createBoxFilter() 和cv::createMorphologyFilter().，

####三、图像线性滤波综合示例程序

这个示例程序中可以用轨迹条来控制三种线性滤波的核参数值，通过滑动滚动条，就可以控制图像在三种线性滤波下的模糊度，有一定的可玩性。废话不多说，上代码吧：

<pre>
//-----------------------------------【程序说明】----------------------------------------------  
//            程序名称:：【OpenCV入门教程之八】线性滤波专场：方框滤波、均值滤波与高斯滤波 配套源码  
//            开发所用OpenCV版本：2.4.8  
//            2014年3月31 日 Create by 浅墨  
//------------------------------------------------------------------------------------------------  
   
//-----------------------------------【头文件包含部分】---------------------------------------  
//     描述：包含程序所依赖的头文件  
//----------------------------------------------------------------------------------------------  
#include <opencv2/core/core.hpp>  
#include<opencv2/highgui/highgui.hpp>  
#include <opencv2/imgproc/imgproc.hpp>  
#include <iostream>  
   
//-----------------------------------【命名空间声明部分】---------------------------------------  
//     描述：包含程序所使用的命名空间  
//-----------------------------------------------------------------------------------------------   
using namespace std;  
using namespace cv;  
   
   
//-----------------------------------【全局变量声明部分】--------------------------------------  
//     描述：全局变量声明  
//-----------------------------------------------------------------------------------------------  
Mat g_srcImage,g_dstImage1,g_dstImage2,g_dstImage3;//存储图片的Mat类型  
int g_nBoxFilterValue=3;  //方框滤波参数值  
int g_nMeanBlurValue=3;  //均值滤波参数值  
int g_nGaussianBlurValue=3;  //高斯滤波参数值  
   
   
//-----------------------------------【全局函数声明部分】--------------------------------------  
//     描述：全局函数声明  
//-----------------------------------------------------------------------------------------------  
//轨迹条的回调函数  
static void on_BoxFilter(int, void *);            //方框滤波  
static void on_MeanBlur(int, void *);           //均值滤波  
static void on_GaussianBlur(int, void *);                    //高斯滤波  
   
   
   
//-----------------------------------【main( )函数】--------------------------------------------  
//     描述：控制台应用程序的入口函数，我们的程序从这里开始  
//-----------------------------------------------------------------------------------------------  
int main(  )  
{  
       //改变console字体颜色  
       system("color5E");   
   
       //载入原图  
       g_srcImage= imread( "1.jpg", 1 );  
       if(!g_srcImage.data ) { printf("Oh，no，读取srcImage错误~！\n"); return false; }  
   
       //克隆原图到三个Mat类型中  
       g_dstImage1= g_srcImage.clone( );  
       g_dstImage2= g_srcImage.clone( );  
       g_dstImage3= g_srcImage.clone( );  
   
       //显示原图  
       namedWindow("【<0>原图窗口】", 1);  
       imshow("【<0>原图窗口】",g_srcImage);  
   
   
       //=================【<1>方框滤波】==================  
       //创建窗口  
       namedWindow("【<1>方框滤波】", 1);  
       //创建轨迹条  
       createTrackbar("内核值：", "【<1>方框滤波】",&g_nBoxFilterValue, 40,on_BoxFilter );  
       on_MeanBlur(g_nBoxFilterValue,0);  
       imshow("【<1>方框滤波】", g_dstImage1);  
       //================================================  
   
       //=================【<2>均值滤波】==================  
       //创建窗口  
       namedWindow("【<2>均值滤波】", 1);  
       //创建轨迹条  
       createTrackbar("内核值：", "【<2>均值滤波】",&g_nMeanBlurValue, 40,on_MeanBlur );  
       on_MeanBlur(g_nMeanBlurValue,0);  
       //================================================  
   
       //=================【<3>高斯滤波】=====================  
       //创建窗口  
       namedWindow("【<3>高斯滤波】", 1);  
       //创建轨迹条  
       createTrackbar("内核值：", "【<3>高斯滤波】",&g_nGaussianBlurValue, 40,on_GaussianBlur );  
       on_GaussianBlur(g_nGaussianBlurValue,0);  
       //================================================  
   
   
       //输出一些帮助信息  
       cout<<endl<<"\t嗯。好了，请调整滚动条观察图像效果~\n\n"  
              <<"\t按下“q”键时，程序退出~!\n"  
              <<"\n\n\t\t\t\tby浅墨";  
   
       //按下“q”键时，程序退出  
       while(char(waitKey(1))!= 'q') {}  
   
       return 0;  
}  
   
   
//-----------------------------【on_BoxFilter( )函数】------------------------------------  
//     描述：方框滤波操作的回调函数  
//-----------------------------------------------------------------------------------------------  
static void on_BoxFilter(int, void *)  
{  
       //方框滤波操作  
       boxFilter(g_srcImage, g_dstImage1, -1,Size( g_nBoxFilterValue+1, g_nBoxFilterValue+1));  
       //显示窗口  
       imshow("【<1>方框滤波】", g_dstImage1);  
}  
   
   
//-----------------------------【on_MeanBlur( )函数】------------------------------------  
//     描述：均值滤波操作的回调函数  
//-----------------------------------------------------------------------------------------------  
static void on_MeanBlur(int, void *)  
{  
       //均值滤波操作  
       blur(g_srcImage, g_dstImage2, Size( g_nMeanBlurValue+1, g_nMeanBlurValue+1),Point(-1,-1));  
       //显示窗口  
       imshow("【<2>均值滤波】", g_dstImage2);  
}  
   
   
//-----------------------------【on_GaussianBlur( )函数】------------------------------------  
//     描述：高斯滤波操作的回调函数  
//-----------------------------------------------------------------------------------------------  
static void on_GaussianBlur(int, void *)  
{  
       //高斯滤波操作  
       GaussianBlur(g_srcImage, g_dstImage3, Size( g_nGaussianBlurValue*2+1,g_nGaussianBlurValue*2+1 ), 0, 0);  
       //显示窗口  
       imshow("【<3>高斯滤波】", g_dstImage3);  
}  
</pre>